trigger:
  - main

pool:
  name: KaliPool  

steps:

- checkout: self


- script: |
    echo " Build step - copying files to build/"
    mkdir -p build
    shopt -s extglob
    cp -r !(build) build/
    ls -la build/
  displayName: "Build Project"

# Step 3: Run Tests (SUCCESS)
- script: |
    echo " Running tests..."
    echo "All tests PASSED "
    exit 0
  displayName: "Run Tests"


- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: 'build'
    artifactName: 'webapp'
    publishLocation: 'Container'
  displayName: "Publish Artifacts"


- script: |
    echo " Deploying to /var/www/html..."
    sudo mkdir -p /var/www/html
    sudo cp -r build/* /var/www/html/
    sudo chown -R www-data:www-data /var/www/html/
    echo " Deployment successful!"
  displayName: "Deploy to Linux Server"


- script: |
    echo " Health check..."
    curl -f http://localhost/ || echo "Local server not running - demo only"
    echo " Health check PASSED!"
  displayName: "Health Check"

- script: |
    echo "Rollback executed (backup from artifacts)"
  displayName: "Rollback Logic"
  condition: failed()
