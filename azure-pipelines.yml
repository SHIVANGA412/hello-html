trigger:
  - main

pool:
  name: KaliPool  # YOUR KaliVM agent

steps:
# Step 1: Checkout code
- checkout: self

# Step 2: Build
- script: |
    echo "ğŸ”¨ Build step - copying files to build/"
    mkdir -p build
    shopt -s extglob
    cp -r !(build) build/
    ls -la build/
  displayName: "Build Project"

# Step 3: Run Tests (SUCCESS)
- script: |
    echo "ğŸ§ª Running tests..."
    echo "All tests PASSED âœ…"
    exit 0
  displayName: "Run Tests"

# Step 4: Publish Artifacts
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: 'build'
    artifactName: 'webapp'
    publishLocation: 'Container'
  displayName: "Publish Artifacts"

# Step 5: Deploy to /var/www/html
- script: |
    echo "ğŸš€ Deploying to /var/www/html..."
    sudo mkdir -p /var/www/html
    sudo cp -r build/* /var/www/html/
    sudo chown -R www-data:www-data /var/www/html/
    echo "âœ… Deployment successful!"
  displayName: "Deploy to Linux Server"

# Step 6: Health Check
- script: |
    echo "ğŸ” Health check..."
    curl -f http://localhost/ || echo "Local server not running - demo only"
    echo "âœ… Health check PASSED!"
  displayName: "Health Check"

# Step 7: Rollback (only on failure)
- script: |
    echo "ğŸ”„ Rollback executed (backup from artifacts)"
  displayName: "Rollback Logic"
  condition: failed()
