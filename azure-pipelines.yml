trigger:
  - main

pool:
  name: KaliPool   # Your self-hosted agent pool

steps:
# Step 1: Checkout code
- checkout: self

# Step 2: Build
- script: |
    echo "Build step - copying files"
    mkdir -p build
    shopt -s extglob
    cp -r !(build) build/
  displayName: "Build Project"

# Step 3: Run Tests
- script: |
    echo "Running tests..."
    exit 0
  displayName: "run-tests"

# Step 4: Archive Artifacts
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: 'build'
    artifactName: 'webapp'
    publishLocation: 'Container'
  displayName: "Publish Artifacts"

# Step 5: Deploy using SSH (key-based)
- task: SSH@0
  displayName: "Deploy to Linux Server"
  inputs:
    sshEndpoint: 'myLinuxVM'   # SSH service connection with private key
    runOptions: 'inline'
    inline: |
      echo "Starting Deployment..."
      mkdir -p ~/deployments/previous
      mkdir -p ~/deployments/current
      if [ -d ~/deployments/current ]; then
          cp -r ~/deployments/current/* ~/deployments/previous/
      fi
      cp -r build/* ~/deployments/current/
      echo "Deployment success"

# Step 6: Rollback Logic
- script: |
    if [ $? -ne 0 ]; then
      echo "Rollback triggered"
      cp -r ~/deployments/previous/* ~/deployments/current/
      echo "Rollback complete"
    fi
  displayName: "Rollback Logic"
