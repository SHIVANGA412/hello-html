trigger:
  - main

pool:
  name: KaliPool

steps:
# Step 1: Checkout code
- checkout: self

# Step 2: Build
- script: |
    echo "Build step - copying files"
    mkdir -p build
    shopt -s extglob
    cp -r !(build) build/
  displayName: "Build Project"

# Step 3: Run Tests (FAIL FIRST)
- script: |
    echo "Running tests..."
    exit 0  # â† Screenshot failure, then change to exit 0
  displayName: "run-tests"

# Step 4: Archive Artifacts
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: 'build'
    artifactName: 'webapp'
    publishLocation: 'Container'
  displayName: "Publish Artifacts"

# Step 5: Deploy LOCALLY (No SSH needed)
- script: |
    echo "ðŸ”„ Backing up current version..."
    sudo mkdir -p /var/www/backup
    sudo rm -rf /var/www/backup/*
    if [ -d "/var/www/html" ]; then
      sudo cp -r /var/www/html/* /var/www/backup/ 2>/dev/null || true
    fi
    
    echo "ðŸ“¦ Deploying to web server..."
    sudo rm -rf /var/www/html/*
    sudo cp -r build/* /var/www/html/
    
    echo "ðŸ”„ Restarting web server..."
    sudo systemctl restart nginx 2>/dev/null || sudo systemctl restart apache2 2>/dev/null || echo "Starting Python server"
    
    echo "âœ… Deployment successful!"
  displayName: "Deploy to Linux Server"
  continueOnError: false

# Step 6: Health Check
- script: |
    sleep 2
    curl -f http://localhost/ || exit 1
    echo "âœ… Health check passed!"
  displayName: "Health Check"

# Step 7: Rollback (Only on failure)
- script: |
    echo "âš ï¸ Rollback triggered"
    echo "ðŸ”„ Restoring previous version..."
    sudo rm -rf /var/www/html/*
    sudo cp -r /var/www/backup/* /var/www/html/ 2>/dev/null || true
    sudo systemctl restart nginx 2>/dev/null || sudo systemctl restart apache2 2>/dev/null || true
    echo "âœ… Rollback completed!"
  displayName: "Rollback Logic"
  condition: failed()
