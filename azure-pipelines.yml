trigger:
  - main

pool:
  name: Default   # Use your self-hosted agent pool

steps:
# Step 1: Checkout code
- checkout: self

# Step 2: Build (for HTML nothing to build)
- script: |
    echo "Build step - copying files"
    mkdir -p build
    cp -r * build/
  displayName: "Build Project"

# Step 3: Run Tests (initially fail â†’ later fix)
- script: |
    echo "Running tests..."
    exit 1   # This will fail first
  displayName: "run-tests"

# Step 4: Archive Artifacts
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: 'build'
    artifactName: 'webapp'
    publishLocation: 'Container'
  displayName: "Publish Artifacts"

# Step 5: Deploy using SSH
- task: SSH@0
  displayName: "Deploy to Linux Server"
  inputs:
    sshEndpoint: 'myLinuxVM'   # Use the service connection name you created
    runOptions: 'inline'
    inline: |
      echo "Starting Deployment..."
      mkdir -p ~/deployments/current
      cp -r * ~/deployments/current/
      echo "Deployment success"

# Step 6: Rollback (example, simple logic)
- script: |
    if [ $? -ne 0 ]; then
      echo "Rollback triggered"
      cp -r ~/deployments/previous/* ~/deployments/current/
      echo "Rollback complete"
    fi
  displayName: "Rollback if Deployment Fails"
